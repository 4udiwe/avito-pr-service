# PVZ Backend Service
Сервис для автоматического назначения ревьюеров на pull request'ы.
Назначает ревьюеров на публикуемые PR'ы из команды автора.
Позволяет управлять командами и пользователями.

## Настройка и запуск
1. Клонируйте репозиторий
```
git clone https://github.com/4udiwe/avito-pr-service.git
cd avito-pr-service
```
2. Создайте файл `.env` в корне проекта (можно скопировать [`.env.example`](.env.example)).
3. Выполните команду
```
docker compose up --build -d
```
4. Для остановки используйте команду
```
docker compose down --remove-orphans
```

Сервер доступен по адресу __localhost:8080__

## Функционал
Сервис предоставляет API для работы с командами пользователей и pull request'ами.
Основные ендмоинты сервиса реализованы в сооветсвии со спецификацией API. 

Спецификация API: [swagger](api\swagger.yaml).

### Также были добавлены следующие ендпоинты:
- __GET pullRequest__

    Возвращает все созданные в системе PR'ы.

- __GET teams__

    Возвращает названия всех созданных команд.

- __POST pullRequest/assign__
    ```
    {
        "pull_request_id": "pr-1001",
        "new_reviewer_id": "u1"
    }
    ```
    Позволяет назначить ревьюера из другой команды если PR имеет статус `need more reveiwers` (Количество назначенных ревьюеров < 2). 

- __POST teams/deactivate__
    ```
    {
        "team_name": "payments"
    }
    ```
    Позволяет установить у всех пользователей команды статус `active` = **false**, и переназначить все открытые PR'ы, на которых члены команды были ревьюерами на участников других команд случайным образом.

- __GET stats__

    Позволяет просмотреть общую статистику:
    - Общее число, число открытых и закрытых PR'ов
    - Статистику пользователей:
        - Топ 5 самых занятых пользователей (больше всего назначений в качестве ревьюера)
        - Число активных и неактивных пользователейю
    - Статистику команд:
        - Число команд
        - Самая активная команда (по авторству PR'ов)

## Модель БД
Для хранения данных было решено использовать следующие таблицы
- `app_user` Данные пользователей команд с ссылкой на ID команды и статус пользователя.

- `team` Данные команд.

- `pr` Данные о pull request'ах: ID автора, время создания, статус (`OPEN|MERGED`), флаг `need_more_reveiwers`.

- `pr_reviewers` Данные о ревьюерах: ID пользователя, ID PR'а.

## Общее

### Генерация DTO
Для ендпоинтов, описанных в спецификации используются [`DTO`](internal\dto\dto.gen.go), сгенерированные с помощью `oapi-codegen`.

### Линтер
Конфигурация линтера описана в [`golangci`](.golangci.yaml)

### TxManager
Для транзакций используется TxManager, описанный в [`postgres.go`](pkg\postgres\postgres.go)

## Тестирование
### Unit-тесты
Сервисный слой покрыт модульными тестами. Покрытие составляет `91.5%`. Чтобы запустить тесты и увидеть покрытие можно воспользоваться командой 
    
```
make cover
```

### Интеграционное тестирование
Интеграционный тест исследует работу ендпоинта __teams/deactivate__. 
Сценарий:
- Создание 20 команд по 20 человек
- Для первой команды создание pull request'а от каждого ее пользователя
- Деактивация первой команды

Тест замеряет работу ендпоинта __teams/deactivate__. Полученное при тестировании время представлено ниже.

| Число пользователей             | Время работы ендпоинта |
|---------------------------------|------------------------|
| 20 команд по 20 пользователей   | 3.953437ms             |
| 100 команд по 100 пользователей | 39.417896ms            |

Полученное время укладывается в рамки, заданные в задании.

Запустить тест можно командой 
```
make integration-test
```
### Нагрузочное тестирование
Нагрузочное тестирование было реализовано с помощью `K6`. Cам скрипт описан [`тут`](test\load_test\load_test.js)

Сценарий:
- Создание команды
- Получение команды
- Создание PR для каждого пользователя команды
- Просмотр PR'ов где, каждый пользователь команды является ревьюером 

Запустить тест можно командой 
```
make load-test
```

<details>
  <summary>Результаты теста</summary>

  ```
█ THRESHOLDS                                                                                                                                                         
  checks                                                                                                                                                             
  ✓ 'rate>0.999' rate=100.00%                                                                                                                                        
  http_req_duration                                                                                                                                                  
  ✓ 'p(95)<300' p(95)=157.49ms                                                                                                                                       
                                                                                                                                                                     
█ TOTAL RESULTS                                                                                                                                                      
  checks_total.......: 626116  3433.027712/s                                                                                                                         
  checks_succeeded...: 100.00% 626116 out of 626116                                                                                                                  
  checks_failed......: 0.00%   0 out of 626116
                                                                                                                                                                     
  ✓ team created                                                                                                                                                     
  ✓ team fetched
  ✓ PR created                                                                                                                                                       
  ✓ getReview success                                                                                                                                                
  HTTP                                                                                                                                                               
  http_req_duration..............: avg=83.25ms min=858.01µs med=80.77ms max=877.35ms p(90)=137.08ms p(95)=157.49ms                                                   
    { expected_response:true }...: avg=83.25ms min=858.01µs med=80.77ms max=877.35ms p(90)=137.08ms p(95)=157.49ms
  http_req_failed................: 0.00%  0 out of 626116                                                                                                            
  http_reqs......................: 626116 3433.027712/s                                                                                                              
  EXECUTION                                                                                                                                                          
  dropped_iterations.............: 53174  291.555903/s                                                                                                               
  iteration_duration.............: avg=2.41s   min=1.02s    med=2.52s   max=4.49s    p(90)=3.14s    p(95)=3.41s   
  iterations.....................: 36834  201.962804/s                                                                                                               
  vus............................: 294    min=294         max=500                                                                                                    
  vus_max........................: 500    min=295         max=500
                                                                                                                                                                     
  NETWORK                                                                                                                                                            
  data_received..................: 255 MB 1.4 MB/s
  data_sent......................: 122 MB 670 kB/s

  ```
</details>

## Стек
- Go
- PostgreSQL
- Docker & Docker Compose

## Проблемы и решения
При генерации DTO и последующем тестировании заметил, что полученная структура запроса для ендпоинта __pullRequest/reassign__ отличается от того, что представлено в примере спецификации [swagger](api\swagger.yaml). Было решено использовать сгенерированный DTO, поэтому правильное тело запроса к ручке выглядит так:
```
{
  "pull_request_id": "pr-1001",
  "old_user_id": "u1"
}
```